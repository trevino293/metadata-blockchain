<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COBOL-Blockchain Integration Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #1e3c72;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            background: #f0f4f8;
            padding: 15px 25px;
            border-radius: 10px;
            flex: 1;
            min-width: 200px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-3px);
        }

        .status-item.active {
            background: #4CAF50;
            color: white;
        }

        .status-item.inactive {
            background: #f44336;
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel h2::before {
            content: '';
            width: 5px;
            height: 25px;
            background: #2a5298;
            border-radius: 3px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th {
            background: #2a5298;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .transaction-item {
            background: #f8f9fa;
            border-left: 4px solid #2a5298;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .transaction-item.new {
            border-left-color: #4CAF50;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
        }

        .record-id {
            font-family: 'Courier New', monospace;
            background: #e3f2fd;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .operation {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }

        .operation.create {
            background: #4CAF50;
            color: white;
        }

        .operation.update {
            background: #2196F3;
            color: white;
        }

        .operation.detect {
            background: #FF9800;
            color: white;
        }

        .blockchain-block {
            background: #f0f7ff;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }

        .blockchain-block:hover {
            box-shadow: 0 5px 20px rgba(33, 150, 243, 0.3);
        }

        .block-number {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #2196F3;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .hash {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #666;
            word-break: break-all;
            margin-top: 10px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 5px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: #2a5298;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .refresh-indicator {
            display: inline-block;
            margin-left: 10px;
            animation: spin 2s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .refresh-indicator.active {
            opacity: 1;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .filter-input {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            flex: 1;
            min-width: 200px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #2a5298;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2a5298;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>COBOL-Blockchain Integration Dashboard</h1>
            <p>Real-time monitoring of legacy COBOL systems integrated with Hyperledger Fabric</p>
            
            <div class="status-bar">
                <div class="status-item active" id="cobol-status">
                    <strong>COBOL System</strong><br>
                    <span>Active</span>
                </div>
                <div class="status-item active" id="blockchain-status">
                    <strong>Blockchain</strong><br>
                    <span>Connected</span>
                </div>
                <div class="status-item" id="adapter-status">
                    <strong>Adapter</strong><br>
                    <span>Running</span>
                </div>
                <div class="status-item" id="last-sync">
                    <strong>Last Sync</strong><br>
                    <span id="sync-time">Never</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshData()">
                Refresh Data
                <span class="refresh-indicator" id="refresh-indicator">⟳</span>
            </button>
            <button class="btn secondary" onclick="clearFilters()">Clear Filters</button>
            <input type="text" class="filter-input" id="filter-input" placeholder="Filter by record ID or file name...">
            <button class="btn" onclick="simulateTransaction()">Simulate Transaction</button>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>COBOL Data Sources</h2>
                <div class="loading" id="cobol-loading">Loading COBOL data</div>
                <div id="cobol-data" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Record ID</th>
                                <th>File</th>
                                <th>Operation</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="cobol-tbody">
                        </tbody>
                    </table>
                    <div class="no-data" id="cobol-no-data" style="display: none;">
                        No COBOL transactions found
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>Blockchain Ledger</h2>
                <div class="loading" id="blockchain-loading">Loading blockchain data</div>
                <div id="blockchain-data" style="display: none;">
                    <div id="blockchain-blocks">
                    </div>
                    <div class="no-data" id="blockchain-no-data" style="display: none;">
                        No blockchain blocks found
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>Transaction Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Transactions</div>
                    <div class="stat-number" id="total-transactions">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Blockchain Blocks</div>
                    <div class="stat-number" id="total-blocks">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Files Monitored</div>
                    <div class="stat-number" id="files-monitored">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-number" id="success-rate">100%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8080/api';  // Change this if your Docker container maps to a different port
        
        // Data storage
        let cobolData = [];
        let blockchainData = [];
        let stats = {};
        let isConnected = false;

        // Fetch data from API
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }

        // Fetch all data from API
        async function fetchAllData() {
            try {
                // Fetch transactions
                const transactionsResponse = await fetchData('/transactions');
                if (transactionsResponse) {
                    cobolData = transactionsResponse.transactions.reverse(); // Most recent first
                    isConnected = true;
                }

                // Fetch blocks
                const blocksResponse = await fetchData('/blocks');
                if (blocksResponse) {
                    blockchainData = blocksResponse.blocks.reverse(); // Most recent first
                }

                // Fetch stats
                const statsResponse = await fetchData('/stats');
                if (statsResponse) {
                    stats = statsResponse;
                }

                // Update status
                const statusResponse = await fetchData('/status');
                if (statusResponse) {
                    updateSystemStatus(statusResponse);
                }

                return true;
            } catch (error) {
                console.error('Error fetching data:', error);
                isConnected = false;
                return false;
            }
        }

        // Update system status indicators
        function updateSystemStatus(status) {
            // Update COBOL status
            const cobolStatus = document.getElementById('cobol-status');
            if (status.cobolSystem === 'active') {
                cobolStatus.classList.add('active');
                cobolStatus.querySelector('span').textContent = 'Active';
            } else {
                cobolStatus.classList.remove('active');
                cobolStatus.classList.add('inactive');
                cobolStatus.querySelector('span').textContent = 'Inactive';
            }

            // Update blockchain status
            const blockchainStatus = document.getElementById('blockchain-status');
            if (status.blockchain === 'connected') {
                blockchainStatus.classList.add('active');
                blockchainStatus.querySelector('span').textContent = 'Connected';
            } else {
                blockchainStatus.classList.remove('active');
                blockchainStatus.classList.add('inactive');
                blockchainStatus.querySelector('span').textContent = 'Disconnected';
            }

            // Update adapter status
            const adapterStatus = document.getElementById('adapter-status');
            if (status.adapter === 'running') {
                adapterStatus.classList.add('active');
                adapterStatus.querySelector('span').textContent = 'Running';
            } else {
                adapterStatus.classList.remove('active');
                adapterStatus.classList.add('inactive');
                adapterStatus.querySelector('span').textContent = 'Stopped';
            }
        }

        // Initialize with fallback sample data if API is not available
        function initializeFallbackData() {
            // Only use if API connection fails
            if (!isConnected) {
                cobolData = [
                    {
                        recordId: 'DEMO001',
                        file: 'DEMO.DAT',
                        operation: 'CREATE',
                        timestamp: new Date().toISOString(),
                        status: '00'
                    }
                ];
                blockchainData = [
                    {
                        blockNumber: 1,
                        hash: '0'.repeat(64),
                        previousHash: '0'.repeat(64),
                        timestamp: new Date().toISOString(),
                        transactions: [{
                            source: 'COBOL',
                            recordId: 'DEMO001',
                            operation: 'CREATE',
                            file: 'DEMO.DAT'
                        }]
                    }
                ];
                stats = {
                    totalTransactions: 1,
                    totalBlocks: 1,
                    filesMonitored: 1,
                    successRate: 100
                };
            }
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Render COBOL data
        function renderCobolData() {
            const tbody = document.getElementById('cobol-tbody');
            const filteredData = filterData(cobolData);
            
            if (filteredData.length === 0) {
                document.getElementById('cobol-no-data').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('cobol-no-data').style.display = 'none';
            tbody.innerHTML = filteredData.map(item => `
                <tr>
                    <td><span class="record-id">${item.recordId}</span></td>
                    <td>${item.file}</td>
                    <td><span class="operation ${item.operation.toLowerCase()}">${item.operation}</span></td>
                    <td class="timestamp">${formatTimestamp(item.timestamp)}</td>
                </tr>
            `).join('');
        }

        // Render blockchain data
        function renderBlockchainData() {
            const container = document.getElementById('blockchain-blocks');
            const filteredData = filterBlockchainData(blockchainData);
            
            if (filteredData.length === 0) {
                document.getElementById('blockchain-no-data').style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            document.getElementById('blockchain-no-data').style.display = 'none';
            container.innerHTML = filteredData.map((block, index) => `
                <div class="blockchain-block ${index === 0 ? 'new' : ''}">
                    <div class="block-number">Block #${block.blockNumber}</div>
                    <div><strong>Timestamp:</strong> ${formatTimestamp(block.timestamp)}</div>
                    <div><strong>Transactions:</strong> ${block.transactions.length}</div>
                    ${block.transactions.map(tx => `
                        <div class="transaction-item">
                            <strong>Record:</strong> <span class="record-id">${tx.recordId}</span>
                            <span class="operation ${tx.operation.toLowerCase()}">${tx.operation}</span><br>
                            <span class="timestamp">File: ${tx.file}</span>
                        </div>
                    `).join('')}
                    <div class="hash">
                        <strong>Hash:</strong> ${block.hash}<br>
                        <strong>Previous:</strong> ${block.previousHash}
                    </div>
                </div>
            `).join('');
        }

        // Filter data based on input
        function filterData(data) {
            const filterValue = document.getElementById('filter-input').value.toLowerCase();
            if (!filterValue) return data;
            
            return data.filter(item => 
                item.recordId.toLowerCase().includes(filterValue) ||
                item.file.toLowerCase().includes(filterValue)
            );
        }

        function filterBlockchainData(data) {
            const filterValue = document.getElementById('filter-input').value.toLowerCase();
            if (!filterValue) return data;
            
            return data.filter(block => 
                block.transactions.some(tx => 
                    tx.recordId.toLowerCase().includes(filterValue) ||
                    tx.file.toLowerCase().includes(filterValue)
                )
            );
        }

        // Update statistics
        function updateStats() {
            if (stats.totalTransactions !== undefined) {
                document.getElementById('total-transactions').textContent = stats.totalTransactions;
                document.getElementById('total-blocks').textContent = stats.totalBlocks;
                document.getElementById('files-monitored').textContent = stats.filesMonitored;
                document.getElementById('success-rate').textContent = stats.successRate + '%';
            } else {
                // Fallback calculation
                document.getElementById('total-transactions').textContent = cobolData.length;
                document.getElementById('total-blocks').textContent = blockchainData.length;
                
                const uniqueFiles = new Set(cobolData.map(item => item.file));
                document.getElementById('files-monitored').textContent = uniqueFiles.size;
                
                const successRate = cobolData.filter(item => item.status === '00').length / cobolData.length * 100;
                document.getElementById('success-rate').textContent = Math.round(successRate) + '%';
            }
        }

        // Simulate a new transaction (now creates it via the adapter)
        async function simulateTransaction() {
            // In a real implementation, you would POST to an API endpoint
            // For now, we'll just refresh to get latest data
            await refreshData();
            
            // Show a message
            const adapterStatus = document.getElementById('adapter-status');
            adapterStatus.classList.add('active');
            setTimeout(() => {
                adapterStatus.classList.remove('active');
                adapterStatus.classList.add('active');
            }, 500);
        }

        // Refresh data display
        async function refreshData() {
            const indicator = document.getElementById('refresh-indicator');
            indicator.classList.add('active');
            
            // Fetch latest data from API
            const success = await fetchAllData();
            
            if (success) {
                // Hide loading, show data
                document.getElementById('cobol-loading').style.display = 'none';
                document.getElementById('cobol-data').style.display = 'block';
                document.getElementById('blockchain-loading').style.display = 'none';
                document.getElementById('blockchain-data').style.display = 'block';
                
                renderCobolData();
                renderBlockchainData();
                updateStats();
                
                // Update last sync time
                document.getElementById('sync-time').textContent = formatTimestamp(new Date());
            } else {
                // Show connection error
                console.error('Failed to connect to API, using fallback data');
                initializeFallbackData();
                
                // Update status to show disconnected
                document.getElementById('blockchain-status').classList.remove('active');
                document.getElementById('blockchain-status').classList.add('inactive');
                document.getElementById('blockchain-status').querySelector('span').textContent = 'API Disconnected';
                
                // Still render with fallback data
                document.getElementById('cobol-loading').style.display = 'none';
                document.getElementById('cobol-data').style.display = 'block';
                document.getElementById('blockchain-loading').style.display = 'none';
                document.getElementById('blockchain-data').style.display = 'block';
                
                renderCobolData();
                renderBlockchainData();
                updateStats();
            }
            
            setTimeout(() => {
                indicator.classList.remove('active');
            }, 1000);
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filter-input').value = '';
            refreshData();
        }

        // Filter on input change
        document.getElementById('filter-input').addEventListener('input', refreshData);

        // Auto-refresh every 10 seconds
        setInterval(async () => {
            await refreshData();
        }, 10000);

        // Initialize on load
        window.addEventListener('load', async () => {
            // Try to connect to API
            const success = await fetchAllData();
            
            if (!success) {
                // Use fallback data if API is not available
                initializeFallbackData();
                
                // Show warning message
                console.warn('API not available at ' + API_BASE_URL + '. Using demo data.');
                console.warn('To connect to real data:');
                console.warn('1. Ensure the Docker container is running');
                console.warn('2. Update API_BASE_URL in the script');
                console.warn('3. Ensure port 8080 is mapped in docker-compose.yml');
            }
            
            refreshData();
            
            // Set initial sync time
            document.getElementById('sync-time').textContent = formatTimestamp(new Date());
        });
    </script>
</body>
</html>